# CSV 文件上传功能测试计划

## 测试目标
为 [`backend/routers/upload.py`](backend/routers/upload.py) 中的 CSV 文件上传功能编写全面的单元测试和集成测试。

## 被测试组件分析

### 1. CSVBatchImporter 类
- **位置**: [`backend/routers/upload.py:30-288`](backend/routers/upload.py:30)
- **核心方法**:
  - `_decode_file_content()`: 文件编码解码
  - `_normalize_date_string()`: 日期格式规范化
  - `parse_csv_file()`: CSV 内容解析
  - `batch_import_csv()`: 批量导入主逻辑
  - `_save_failed_record()`: 保存失败记录
  - `_generate_failed_csv()`: 生成失败记录 CSV

### 2. API 端点
- **POST /api/upload/csv**: CSV 文件上传
- **GET /api/upload/download/{filename}**: 下载失败记录

## 测试策略

### 单元测试
1. **文件解码测试**: 测试不同编码格式（UTF-8, GBK, UTF-16）的解码
2. **日期规范化测试**: 测试各种日期格式的转换
3. **CSV 解析测试**: 测试不同分隔符、字段缺失、格式异常等情况
4. **批量导入测试**: 测试成功导入、失败处理、事务回滚等
5. **失败记录处理测试**: 测试失败记录的保存和 CSV 生成

### 集成测试
1. **API 端点测试**: 测试完整的上传流程
2. **错误处理测试**: 测试各种异常情况的处理

## 测试文件结构

```
backend/tests/test_upload.py
├── TestCSVBatchImporter
│   ├── TestFileDecoding
│   ├── TestDateNormalization
│   ├── TestCSVParsing
│   ├── TestBatchImport
│   └── TestFailedRecordHandling
└── TestUploadAPI
    ├── TestUploadEndpoint
    └── TestDownloadEndpoint
```

## 详细测试用例

### 1. 文件解码测试 (_decode_file_content)

#### 测试用例 1.1: UTF-8 编码检测
- **输入**: UTF-8 编码的 CSV 内容
- **预期**: 正确解码为字符串

#### 测试用例 1.2: UTF-8 with BOM 检测
- **输入**: 带 BOM 的 UTF-8 文件
- **预期**: 使用 utf-8-sig 编码解码

#### 测试用例 1.3: UTF-16 编码检测
- **输入**: UTF-16 编码的文件
- **预期**: 正确识别并解码

#### 测试用例 1.4: GBK/GB2312 编码检测
- **输入**: GBK 编码的中文 CSV
- **预期**: 正确解码中文字符

#### 测试用例 1.5: 未知编码回退
- **输入**: 无法识别的编码
- **预期**: 使用 UTF-8 errors='ignore' 模式解码

### 2. 日期规范化测试 (_normalize_date_string)

#### 测试用例 2.1: 中文日期格式
- **输入**: "2023年12月25日"
- **预期**: "2023-12-25"

#### 测试用例 2.2: 斜杠分隔格式
- **输入**: "2023/12/25"
- **预期**: "2023-12-25"

#### 测试用例 2.3: 点分隔格式
- **输入**: "2023.12.25"
- **预期**: "2023-12-25"

#### 测试用例 2.4: 单数字补零
- **输入**: "2023年1月5日"
- **预期**: "2023-01-05"

#### 测试用例 2.5: 无效日期格式
- **输入**: "invalid-date"
- **预期**: 返回原始字符串

#### 测试用例 2.6: dateutil 解析器回退
- **输入**: 复杂日期格式
- **预期**: 使用 dateutil 解析器成功转换

### 3. CSV 解析测试 (parse_csv_file)

#### 测试用例 3.1: 标准逗号分隔
- **输入**: 标准 CSV 格式
- **预期**: 正确解析为字典列表

#### 测试用例 3.2: 分号分隔
- **输入**: 分号分隔的 CSV
- **预期**: 自动检测并正确解析

#### 测试用例 3.3: 制表符分隔
- **输入**: TSV 格式
- **预期**: 自动检测并正确解析

#### 测试用例 3.4: 字段缺失处理
- **输入**: 某些行字段不足
- **预期**: 用空字符串填充缺失字段

#### 测试用例 3.5: 多余字段处理
- **输入**: 某些行字段过多
- **预期**: 截断多余字段

#### 测试用例 3.6: 空列名处理
- **输入**: 包含空列名的 CSV
- **预期**: 跳过空列名

#### 测试用例 3.7: BOM 处理
- **输入**: 带 BOM 的表头
- **预期**: 正确清理 BOM 字符

#### 测试用例 3.8: 日期字段规范化
- **输入**: 包含各种日期格式的 CSV
- **预期**: 日期字段自动规范化

#### 测试用例 3.9: 空文件处理
- **输入**: 空 CSV 文件
- **预期**: 抛出 FileProcessingException

#### 测试用例 3.10: 无表头处理
- **输入**: 无表头的 CSV
- **预期**: 抛出 FileProcessingException

### 4. 批量导入测试 (batch_import_csv)

#### 测试用例 4.1: 成功导入单条记录
- **输入**: 单条有效房源数据
- **预期**: 成功导入，返回 UploadResult (total=1, success=1, failed=0)

#### 测试用例 4.2: 成功导入多条记录
- **输入**: 多条有效房源数据
- **预期**: 全部成功导入

#### 测试用例 4.3: 部分成功导入
- **输入**: 混合有效和无效数据
- **预期**: 有效数据成功，无效数据失败

#### 测试用例 4.4: 数据验证失败
- **输入**: 缺少必填字段的数据
- **预期**: 验证失败，记录到失败列表

#### 测试用例 4.5: 导入异常处理
- **输入**: 导致数据库异常的数据
- **预期**: 异常捕获，记录失败

#### 测试用例 4.6: 批次处理
- **输入**: 超过 BATCH_SIZE 的数据量
- **预期**: 按批次处理，正确提交事务

#### 测试用例 4.7: 在售房源导入
- **输入**: 在售房源数据
- **预期**: 正确创建 PropertyCurrent 记录

#### 测试用例 4.8: 成交房源导入
- **输入**: 成交房源数据
- **预期**: 正确创建 PropertyCurrent 记录，状态为 SOLD

#### 测试用例 4.9: 更新现有房源
- **输入**: 已存在房源的更新数据
- **预期**: 更新现有记录，创建历史快照

#### 测试用例 4.10: 小区自动创建
- **输入**: 新小区房源数据
- **预期**: 自动创建小区记录

### 5. 失败记录处理测试

#### 测试用例 5.1: 保存失败记录
- **输入**: 验证失败的数据
- **预期**: 正确保存到 FailedRecord 表

#### 测试用例 5.2: 生成失败 CSV
- **输入**: 失败记录列表
- **预期**: 生成包含行号、错误原因、数据的 CSV 文件

#### 测试用例 5.3: 无失败记录
- **输入**: 空失败列表
- **预期**: 返回 None，不生成文件

### 6. API 端点测试

#### 测试用例 6.1: 上传 CSV 文件
- **输入**: 有效的 CSV 文件
- **预期**: 返回 200 状态码和 UploadResult

#### 测试用例 6.2: 上传非 CSV 文件
- **输入**: .txt 文件
- **预期**: 返回 400 错误，提示只支持 CSV

#### 测试用例 6.3: 上传空文件
- **输入**: 空 CSV 文件
- **预期**: 返回 400 错误

#### 测试用例 6.4: 下载失败记录
- **输入**: 有效的失败记录文件名
- **预期**: 返回 CSV 文件下载

#### 测试用例 6.5: 下载不存在的文件
- **输入**: 无效的文件名
- **预期**: 返回 404 错误

### 7. 边界情况和错误处理

#### 测试用例 7.1: 特殊字符处理
- **输入**: 包含特殊字符的字段值
- **预期**: 正确处理，不抛出异常

#### 测试用例 7.2: 大数据量处理
- **输入**: 大量数据（1000+ 条）
- **预期**: 正确处理，不内存溢出

#### 测试用例 7.3: 并发处理
- **输入**: 模拟并发上传
- **预期**: 正确处理，数据一致性

#### 测试用例 7.4: 事务回滚
- **输入**: 导致事务失败的数据
- **预期**: 正确回滚，数据一致性

## 测试数据准备

### 有效 CSV 数据示例
```csv
数据源,房源ID,状态,小区名,室,厅,卫,朝向,楼层,面积,挂牌价,上架时间
链家,TEST001,在售,测试小区A,3,2,2,南,15/28,120.5,800,2024-01-01
贝壳,TEST002,成交,测试小区B,2,1,1,东南,8/18,85,550,2024-01-15
```

### 无效 CSV 数据示例
```csv
数据源,房源ID,状态,小区名,室,厅,卫,朝向,楼层,面积,挂牌价,上架时间
链家,TEST003,在售,测试小区C,3,2,2,南,15/28,120.5,,2024-01-01  # 缺少挂牌价
贝壳,TEST004,无效状态,测试小区D,2,1,1,东南,8/18,85,550,2024-01-15  # 无效状态
```

## 测试覆盖率目标
- **行覆盖率**: > 90%
- **分支覆盖率**: > 85%
- **关键路径**: 100% 覆盖

## 测试执行计划

### 第一阶段: 单元测试
1. 文件解码测试
2. 日期规范化测试
3. CSV 解析测试

### 第二阶段: 集成测试
1. 批量导入测试
2. 失败记录处理测试

### 第三阶段: API 测试
1. 上传端点测试
2. 下载端点测试

### 第四阶段: 边界测试
1. 错误处理测试
2. 性能测试

## 依赖和工具
- **测试框架**: pytest
- **HTTP 测试**: httpx, fastapi.testclient
- **数据库**: SQLite (内存数据库)
- **覆盖率**: pytest-cov

## 注意事项
1. 使用内存数据库避免测试数据污染
2. 每个测试用例独立，不依赖执行顺序
3. 清理测试产生的临时文件
4. 模拟外部依赖（如文件系统操作）
5. 测试各种编码格式的兼容性