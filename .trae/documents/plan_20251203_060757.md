# 现金流前后端数据连通实现计划

## 1. 需求分析
目前现金流功能前后端已分别实现，但尚未连通。需要确保前端能正确调用后端API，获取、展示和提交现金流数据。

## 2. 前后端现状分析

### 前端现状
- **组件**：`CashFlow.vue` 使用 store 中的模拟数据
- **Store**：`store.ts` 中有模拟的 `cashFlows` 数据，已实现 `addCashFlow` 和 `deleteCashFlow` 方法调用API
- **API调用**：`projects.ts` 中已实现现金流相关API调用函数
- **数据格式**：期望后端返回包含 `records` 和 `summary` 的数据结构

### 后端现状
- **路由**：`cashflow.py` 已实现完整的CRUD接口
- **服务**：`cashflow_service.py` 已实现业务逻辑
- **数据格式**：返回 `BaseResponse` 包装的数据，包含 `records` 和 `summary`

## 3. 实现步骤

### 步骤1：修改前端Store，添加现金流数据加载方法
- 在 `store.ts` 中添加 `loadCashFlows` 方法，调用 `fetchProjectCashFlow` API
- 修改 `cashFlows` 状态，支持从后端加载数据

### 步骤2：修改前端组件，初始化加载数据
- 在 `CashFlow.vue` 中添加 `onMounted` 生命周期钩子
- 调用 `loadCashFlows` 方法加载项目现金流数据
- 确保组件能正确处理异步数据加载状态

### 步骤3：调整API调用逻辑，确保数据格式匹配
- 检查 `projects.ts` 中的API调用函数，确保与后端返回格式一致
- 处理后端返回的 `BaseResponse` 包装格式
- 确保金额单位转换正确（前端使用万元，后端存储实际金额）

### 步骤4：测试功能完整性
- 测试现金流记录的创建、展示和删除功能
- 验证统计数据（总收入、总支出、净现金流）计算正确
- 测试投资回报分析数据（ROI、年化回报率、资金占用周期）

## 4. 具体修改点

### 前端修改点
1. **store.ts**：
   - 添加 `loadCashFlows` 方法
   - 修改 `cashFlows` 初始化逻辑
   - 确保 `addCashFlow` 和 `deleteCashFlow` 方法正确更新本地状态

2. **CashFlow.vue**：
   - 添加 `onMounted` 钩子，调用 `loadCashFlows`
   - 处理加载状态和错误情况
   - 确保表单提交和删除操作正确调用API

3. **projects.ts**：
   - 调整API调用函数，确保正确处理后端返回的 `BaseResponse` 格式
   - 检查金额单位转换

### 后端修改点
- 确保 `cashflow_service.py` 返回的数据格式与前端期望一致
- 验证 `get_cashflow_summary` 方法返回正确的统计数据

## 5. 测试验证
- 功能测试：创建、展示、删除现金流记录
- 数据一致性测试：前后端数据一致
- 错误处理测试：网络错误、API错误等情况
- 边界情况测试：空数据、大量数据等情况

## 6. 风险控制
- 确保修改不影响其他功能模块
- 保持前端现有交互体验不变
- 添加适当的错误处理和加载状态
- 确保数据格式转换正确，避免金额计算错误

## 7. 预期结果
- 前端组件能正确从后端加载现金流数据
- 现金流记录的创建和删除操作能实时同步到后端
- 统计数据和投资回报分析能正确计算和展示
- 系统能处理各种异常情况，保持稳定运行