
**ç‰ˆæœ¬**: 2.0
**æ—¥æœŸ**: 2025-11-15
**çŠ¶æ€**: âœ… **æœ€ç»ˆç‰ˆï¼Œå¯ç›´æ¥å¼€å‘ (Final, Ready for Engineer)**
**é¢å‘**: å…¨æ ˆå·¥ç¨‹å¸ˆ (æ— é¡¹ç›®å‰æœŸèƒŒæ™¯)

---

### **1. é¡¹ç›®æ¦‚è¿°**

#### **1.1 é¡¹ç›®å®šä½**

**â€œä¸ªäººæˆ¿äº§æ•°æ®ä»“åº“â€**ã€‚

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ªè½»é‡çº§ã€æœ¬åœ°åŒ–ã€é«˜æ€§èƒ½çš„æˆ¿äº§æ•°æ®ä¸­å¿ƒã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡æ ‡å‡†åŒ–çš„ CSV æ–‡ä»¶æˆ– API æ¥å£ï¼Œå°†æ¥è‡ªä¸åŒæ¸ é“çš„æˆ¿æºæ•°æ®ï¼ˆåŒ…æ‹¬åœ¨å”®ä¸æˆäº¤ï¼‰æ±‡é›†åˆ°ç»Ÿä¸€çš„æœ¬åœ°æ•°æ®åº“ä¸­ã€‚ç³»ç»Ÿæä¾›æ•°æ®æ¸…æ´—ã€æ ¡éªŒã€æŸ¥è¯¢ã€ç­›é€‰å’Œå¯¼å‡ºçš„å…¨æµç¨‹åŠŸèƒ½ã€‚

#### **1.2 æ ¸å¿ƒç›®æ ‡**

1.  **å¿«é€Ÿéƒ¨ç½²**: å·¥ç¨‹å¸ˆåœ¨ 10 åˆ†é’Ÿå†…å®Œæˆæœ¬åœ°ç¯å¢ƒæ­å»ºä¸ä¸€é”®å¯åŠ¨ã€‚
2.  **æ•°æ®å¥å£®æ€§**: å»ºç«‹ä¸¥æ ¼çš„æ•°æ®æ¥æ”¶å¥‘çº¦ï¼Œä¿è¯å…¥åº“æ•°æ®çš„å¹²å‡€ä¸å®Œæ•´ï¼Œä»»ä½•ä¸åˆè§„æ•°æ®éƒ½å°†è¢«éš”ç¦»è®°å½•ï¼Œç¡®ä¿â€œé›¶ä¸¢å¤±â€ã€‚
3.  **é«˜æ€§èƒ½æŸ¥è¯¢**: å‰ç«¯åˆ—è¡¨æ”¯æŒå¯¹æµ·é‡æ•°æ®ï¼ˆä¸‡æ¡çº§åˆ«ï¼‰è¿›è¡Œæµç•…çš„è™šæ‹Ÿæ»šåŠ¨ã€å¤šç»´åº¦ç­›é€‰å’Œæ’åºã€‚
4.  **æ•°æ®æ²»ç†**: æä¾›åå°å·¥å…·ï¼Œå…è®¸ç”¨æˆ·å¯¹æ¥è‡ªå¤šæ¸ é“çš„é‡å¤å°åŒºæ•°æ®è¿›è¡Œæ‰‹åŠ¨åˆå¹¶ï¼ŒæŒç»­æå‡æ•°æ®è´¨é‡ã€‚

#### **1.3 æŠ€æœ¯æ ˆ**

| ç±»åˆ« | æŠ€æœ¯ | ç‰ˆæœ¬/å·¥å…· | èŒè´£ |
| :--- | :--- | :--- | :--- |
| **åç«¯** | Python | 3.10+ | ä¸»è¦å¼€å‘è¯­è¨€ |
| | FastAPI | â‰¥0.104 | Web æ¡†æ¶ï¼Œæä¾› API æ¥å£ |
| | SQLAlchemy | 2.0+ | ORMï¼Œä¸æ•°æ®åº“äº¤äº’ |
| | Pydantic | 2.5+ | æ•°æ®æ ¡éªŒä¸æ¨¡å‹å®šä¹‰ |
| | UV | - | Python åŒ…ç®¡ç†å™¨ï¼Œæ›¿ä»£ pip å’Œ venv |
| **å‰ç«¯** | Vue.js | 3.x | æ ¸å¿ƒæ¡†æ¶ |
| | Vite | 5.x | æ„å»ºå·¥å…· |
| | TypeScript | 5.x | æä¾›ç±»å‹å®‰å…¨ |
| | Pinia | 2.x | çŠ¶æ€ç®¡ç† |
| | TailwindCSS | 3.x | UI æ ·å¼ |
| | pnpm | - | Node.js åŒ…ç®¡ç†å™¨ |
| **æ•°æ®åº“**| SQLite | - | æœ¬åœ°æ–‡ä»¶æ•°æ®åº“ï¼Œæ— éœ€é¢å¤–å®‰è£…æœåŠ¡ |

---

### **2. ç³»ç»Ÿæ¶æ„ä¸æ•°æ®æµ**

#### **2.1 æ•´ä½“æ¶æ„å›¾**

æœ¬ç³»ç»Ÿé‡‡ç”¨ç»å…¸çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼ŒèŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ã€‚

```text
+------------------+          HTTP API è¯·æ±‚             +--------------------+
|                  | (GET /properties, POST /upload)     |                    |
|   å‰ç«¯ (Frontend)  +-----------------------------------> |  åç«¯ (Backend)    |
| (Vue3, è¿è¡Œäº:3000)| <----------------------------------- | (FastAPI, è¿è¡Œäº:8000)|
|                  |    (JSON æ•°æ® / CSV æ–‡ä»¶æµ)           |                    |
+------------------+                                     +--------------------+
         ^                                                          |
         | ç”¨æˆ·äº¤äº’ (ç­›é€‰ã€ä¸Šä¼ ç­‰)                                  | SQLAlchemy ORM
         |                                                          | (æ•°æ®åº“æ“ä½œ)
+--------+---------+                                     +---------V----------+
|  ç”¨æˆ·çš„æµè§ˆå™¨    |                                     | æ•°æ®åº“ (Database)  |
+------------------+                                     | (SQLite: data.db)  |
                                                         +--------------------+
```

#### **2.2 æœ€ç»ˆé¡¹ç›®ç›®å½•ç»“æ„**

è¿™æ˜¯æ‚¨å°†è¦å¼€å‘çš„å®Œæ•´ä»£ç åº“ç»“æ„ã€‚

```text
profo-real-estate/
â”œâ”€ backend/                     # åç«¯ä»£ç 
â”‚  â”œâ”€ routers/                  # API è·¯ç”±å±‚
â”‚  â”‚  â”œâ”€ properties.py         # æˆ¿æºæŸ¥è¯¢ä¸å¯¼å‡º API
â”‚  â”‚  â”œâ”€ upload.py             # CSV ä¸Šä¼  API
â”‚  â”‚  â”œâ”€ push.py               # JSON æ¨é€ API
â”‚  â”‚  â””â”€ admin.py              # ã€æ–°å¢ã€‘å°åŒºç®¡ç† API
â”‚  â”œâ”€ services/                 # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”‚  â”‚  â”œâ”€ importer.py           # æ•°æ®å¯¼å…¥ä¸å¤„ç†æ ¸å¿ƒé€»è¾‘
â”‚  â”‚  â”œâ”€ parser.py             # æ¥¼å±‚è§£æç­‰å·¥å…·å‡½æ•°
â”‚  â”‚  â””â”€ merger.py             # ã€æ–°å¢ã€‘å°åŒºåˆå¹¶æœåŠ¡
â”‚  â”œâ”€ main.py                   # FastAPI åº”ç”¨å…¥å£
â”‚  â”œâ”€ models.py                 # SQLAlchemy æ•°æ®è¡¨æ¨¡å‹
â”‚  â”œâ”€ schemas.py                # Pydantic æ•°æ®æ ¡éªŒæ¨¡å‹ (æ•°æ®å¥‘çº¦)
â”‚  â”œâ”€ db.py                     # æ•°æ®åº“è¿æ¥ä¸åˆå§‹åŒ–
â”‚  â”œâ”€ settings.py               # åº”ç”¨é…ç½®
â”‚  â”œâ”€ pyproject.toml            # UV ä¾èµ–ç®¡ç†
â”‚  â””â”€ requirements.lock
â”œâ”€ frontend/                    # å‰ç«¯ä»£ç 
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ api/
â”‚  â”‚  â”‚  â””â”€ client.ts           # Axios API å®¢æˆ·ç«¯
â”‚  â”‚  â”œâ”€ components/
â”‚  â”‚  â”‚  â”œâ”€ FileUpload.vue      # æ–‡ä»¶ä¸Šä¼ ç»„ä»¶
â”‚  â”‚  â”‚  â”œâ”€ PropertyList.vue    # æˆ¿æºè™šæ‹Ÿæ»šåŠ¨åˆ—è¡¨
â”‚  â”‚  â”‚  â”œâ”€ ExportBtn.vue       # å¯¼å‡ºæŒ‰é’®
â”‚  â”‚  â”‚  â”œâ”€ PropertyDetailModal.vue # ã€æ–°å¢ã€‘æˆ¿æºè¯¦æƒ…å¼¹çª—
â”‚  â”‚  â”‚  â””â”€ CommunityMergeConsole.vue # ã€æ–°å¢ã€‘å°åŒºåˆå¹¶æ“ä½œå°
â”‚  â”‚  â”œâ”€ pages/ (æˆ– views/)     # é¡µé¢çº§ç»„ä»¶
â”‚  â”‚  â”‚  â”œâ”€ HomeView.vue        # ä¸»é¡µ
â”‚  â”‚  â”‚  â”œâ”€ UploadView.vue      # ä¸Šä¼ é¡µ
â”‚  â”‚  â”‚  â””â”€ AdminMergeView.vue    # ã€æ–°å¢ã€‘å°åŒºæ•°æ®æ²»ç†é¡µ
â”‚  â”‚  â”œâ”€ stores/
â”‚  â”‚  â”‚  â””â”€ property.ts         # Pinia çŠ¶æ€ç®¡ç† (ç­›é€‰ã€æ’åºç­‰)
â”‚  â”‚  â”œâ”€ router/
â”‚  â”‚  â”‚  â””â”€ index.ts            # Vue-Router è·¯ç”±å®šä¹‰
â”‚  â”‚  â”œâ”€ main.ts                 # Vue åº”ç”¨å…¥å£
â”‚  â”‚  â””â”€ style.css
â”‚  â”œâ”€ package.json              # pnpm ä¾èµ–ç®¡ç†
â”‚  â”œâ”€ pnpm-lock.yaml
â”‚  â”œâ”€ vite.config.ts
â”‚  â””â”€ tsconfig.json
â”œâ”€ start.bat                     # Windows ä¸€é”®å¯åŠ¨è„šæœ¬
â”œâ”€ start.sh                      # macOS / Linux ä¸€é”®å¯åŠ¨è„šæœ¬
â””â”€ README.md                     # ç®€æ˜å®‰è£…è¿è¡Œè¯´æ˜
```

---

### **3. æ ¸å¿ƒä¸šåŠ¡æµç¨‹**

#### **3.1 ä¸šåŠ¡æµç¨‹ä¸€ï¼šæ•°æ®æ¥æ”¶ä¸å…¥åº“**

æ­¤æµç¨‹æ˜¯ç³»ç»Ÿçš„æ•°æ®å…¥å£ï¼Œç¡®ä¿æ‰€æœ‰è¿›å…¥çš„æ•°æ®éƒ½ç»è¿‡æ ‡å‡†åŒ–å¤„ç†ã€‚

```mermaid
graph TD
    subgraph "æ•°æ®æ¥æº"
        A[ç”¨æˆ·ä¸Šä¼ CSVæ–‡ä»¶] --> C{POST /api/upload/csv};
        B[å¤–éƒ¨ç³»ç»Ÿæ¨é€JSON] --> D{POST /api/push};
    end

    subgraph "åç«¯å¤„ç†é€»è¾‘"
        C & D --> E[1. ä½¿ç”¨ Pydantic æ¨¡å‹è¿›è¡Œå­—æ®µæ˜ å°„ä¸ä¸¥æ ¼æ ¡éªŒ];
        E --"æ ¡éªŒå¤±è´¥"--> F[å°†åŸå§‹æ•°æ®è¡Œä¸é”™è¯¯åŸå› å†™å…¥ `failed_records` è¡¨];
        E --"æ ¡éªŒæˆåŠŸ"--> G[2. æ ¹æ®æ•°æ®ä¸­çš„`å°åŒºå`æŸ¥è¯¢ `communities` è¡¨];
        
        G --"å°åŒºä¸å­˜åœ¨"--> H[åœ¨ `communities` è¡¨ä¸­åˆ›å»ºæ–°å°åŒºè®°å½•];
        H --> I[è·å–æ–°ç”Ÿæˆçš„å°åŒº community_id];
        G --"å°åŒºå·²å­˜åœ¨"--> I[è·å–å·²æœ‰çš„å°åŒº community_id];

        I --> J{3. ä½¿ç”¨ (data_source, source_property_id) æŸ¥è¯¢ `property_current` è¡¨};

        J --"æˆ¿æºå·²å­˜åœ¨"--> K[a. å°†æ•°æ®åº“ä¸­å½“å‰æˆ¿æºçš„å®Œæ•´ä¿¡æ¯å¤åˆ¶åˆ° `property_history` è¡¨ä½œä¸ºå¿«ç…§];
        K --> L[b. ä½¿ç”¨æ–°æ•°æ®æ›´æ–° `property_current` è¡¨ä¸­çš„ä»·æ ¼ã€çŠ¶æ€ç­‰åŠ¨æ€å­—æ®µ];

        J --"æˆ¿æºä¸å­˜åœ¨"--> M[a. è°ƒç”¨æœåŠ¡è§£ææ¥¼å±‚å­—ç¬¦ä¸²];
        M --> N[b. è®¡ç®—æ™ºèƒ½æ¥¼å±‚çº§åˆ« (é«˜/ä¸­/ä½)];
        N --> O[c. ä½¿ç”¨æ–°æ•°æ®å’Œè·å–çš„ community_id åœ¨ `property_current` è¡¨ä¸­åˆ›å»ºä¸€æ¡å…¨æ–°è®°å½•];
    end

    subgraph "å“åº”"
       F & L & O --> P[å¤„ç†å®Œæˆï¼Œå‘ä¸Šæ¸¸è¿”å›å¤„ç†ç»“æœç»Ÿè®¡];
    end
```

#### **3.2 ä¸šåŠ¡æµç¨‹äºŒï¼šæ•°æ®æŸ¥è¯¢ä¸å¯¼å‡º**

æ­¤æµç¨‹æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç”¨æˆ·åœºæ™¯ï¼Œæä¾›å¼ºå¤§çš„æ•°æ®æ£€ç´¢å’Œå¯¼å‡ºåŠŸèƒ½ã€‚

```mermaid
graph TD
    subgraph "å‰ç«¯ç”¨æˆ·æ“ä½œ"
        A[ç”¨æˆ·åœ¨ç­›é€‰åŒºæ“ä½œ] --> B[åˆ‡æ¢çŠ¶æ€(åœ¨å”®/æˆäº¤)ã€æ‹–åŠ¨ä»·æ ¼æ»‘å—ç­‰];
        B --> C[ç­›é€‰æ¡ä»¶æ›´æ–°åˆ° Pinia store];
        C --"çŠ¶æ€å˜æ›´"--> D[useQuery è‡ªåŠ¨ä½¿ç”¨æ–°æ¡ä»¶è¯·æ±‚ API];
    end

    subgraph "åç«¯ API å“åº”"
        D --"GET /api/properties?params..."--> E[åç«¯æ¥å£æ¥æ”¶è¯·æ±‚];
        E --> F[æ ¹æ®å‚æ•°æ„å»º SQLAlchemy æŸ¥è¯¢è¯­å¥];
        F --> G[ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®];
        G --> H[åœ¨è¿”å›å‰è®¡ç®—é™„åŠ å­—æ®µ (å¦‚å•ä»·ã€çŠ¶æ€å)];
        H --> I[è¿”å›åˆ†é¡µåçš„ JSON æ•°æ®];
    end
    
    subgraph "å‰ç«¯é¡µé¢æ¸²æŸ“"
         I --> J[PropertyList ç»„ä»¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨é«˜æ•ˆæ¸²æŸ“åˆ—è¡¨];
    end

    subgraph "å¯¼å‡ºæµç¨‹"
        K[ç”¨æˆ·ç‚¹å‡» 'å¯¼å‡º' æŒ‰é’®] --> L[ä» Pinia è·å–å½“å‰æ‰€æœ‰ç­›é€‰å’Œæ’åºå‚æ•°];
        L --"GET /api/properties/export?params..."--> M[è°ƒç”¨å¯¼å‡º APIï¼Œå‚æ•°ä¸æŸ¥è¯¢å®Œå…¨ä¸€è‡´];
        M --> N[åç«¯å¤ç”¨æŸ¥è¯¢é€»è¾‘ï¼Œç”Ÿæˆ CSV æ–‡ä»¶æµ];
        N --> O[æµè§ˆå™¨è§¦å‘æ–‡ä»¶ä¸‹è½½];
    end
```

#### **3.3 ä¸šåŠ¡æµç¨‹ä¸‰ï¼šå°åŒºæ•°æ®æ²»ç†**

æ­¤æµç¨‹æ˜¯åå°ç®¡ç†åŠŸèƒ½ï¼Œç”¨äºæå‡æ•°æ®è´¨é‡ã€‚

1.  **æŸ¥æ‰¾**: ç®¡ç†å‘˜åœ¨æ²»ç†é¡µé¢æœç´¢ç›¸ä¼¼çš„å°åŒºåï¼ˆå¦‚ "XXå°åŒº", "XXå®¶å›­"ï¼‰ã€‚
2.  **é€‰æ‹©**: åœ¨æœç´¢ç»“æœä¸­ï¼Œå‹¾é€‰å¤šä¸ªç–‘ä¼¼é‡å¤çš„å°åŒºè®°å½•ã€‚
3.  **æŒ‡å®šä¸»è®°å½•**: åœ¨é€‰ä¸­çš„è®°å½•ä¸­ï¼ŒæŒ‡å®šä¸€ä¸ªä½œä¸ºæ ‡å‡†åç§°ï¼ˆä¸»è®°å½•ï¼‰ã€‚
4.  **ç¡®è®¤åˆå¹¶**: ç³»ç»Ÿå¼¹çª—æç¤ºæ“ä½œåæœï¼ˆå¤šå°‘å¥—æˆ¿æºå°†è¢«å½±å“ç­‰ï¼‰ï¼Œç®¡ç†å‘˜ç¡®è®¤ã€‚
5.  **åç«¯æ‰§è¡Œ**:
    *   å°†è¢«åˆå¹¶çš„å°åŒºåï¼Œä½œä¸ºåˆ«åå­˜å…¥ `community_aliases` è¡¨ï¼Œå¹¶å…³è”åˆ°ä¸»è®°å½•ã€‚
    *   å°†è¢«åˆå¹¶å°åŒºå…³è”çš„æ‰€æœ‰æˆ¿æºï¼Œå…¶ `community_id` å…¨éƒ¨æ›´æ–°ä¸ºä¸»è®°å½•çš„ IDã€‚
    *   è½¯åˆ é™¤è¢«åˆå¹¶çš„å°åŒºè®°å½•ã€‚

---

### **4. å‰ç«¯è¯¦ç»†è®¾è®¡**

#### **4.1 é¡µé¢å¸ƒå±€çº¿æ¡†å›¾**

**ä¸»é¡µ (`/`) - æˆ¿æºåˆ—è¡¨ã€ç­›é€‰ä¸å¯¼å‡º**
```text
+----------------------------------------------------------------------------------------------------------+
| Profo æˆ¿äº§æ•°æ®ä¸­å¿ƒ                                                 [ ä¸»é¡µ ] [ ä¸Šä¼  ] [ æ•°æ®æ²»ç† ]          |
+----------------------------------------------------------------------------------------------------------+
| [ ç­›é€‰åŒº Filters ]                                                                                       |
|                                                                                                          |
|  çŠ¶æ€:   [[ å…¨éƒ¨ ]]  [ åœ¨å”® ]  [ æˆäº¤ ]  (Pinia çŠ¶æ€é©±åŠ¨ï¼Œç‚¹å‡»ååˆ—è¡¨è‡ªåŠ¨åˆ·æ–°)                                 |
|  å°åŒºå: [ "é˜³å…‰éƒ½å¸‚"________________ ]                                                                    |
|  æ€»ä»· (ä¸‡):  0 o-------------------o 20000 (åŒæ»‘å—èŒƒå›´é€‰æ‹©)                                                 |
|  é¢ç§¯ (ã¡):  0 o-------------o 300                                                                         |
|  æˆ·å‹:  [ âœ“ 2å®¤, âœ“ 3å®¤, 4å®¤, 5å®¤+ â–¼] (å¤šé€‰ä¸‹æ‹‰æ¡†)                                                         |
|                                                                          +-----------------------------+ |
|                                                                          | [ ğŸ“¥ å¯¼å‡ºå½“å‰è§†å›¾ä¸º CSV ]   | |
|                                                                          +-----------------------------+ |
+----------------------------------------------------------------------------------------------------------+
| [ æˆ¿æºåˆ—è¡¨ PropertyList.vue - ç”± @tanstack/vue-virtual é©±åŠ¨ ]                                            |
+----------------------------------------------------------------------------------------------------------+
| | çŠ¶æ€ | å°åŒºå     | æˆ·å‹   | æœå‘ | æ¥¼å±‚      | é¢ç§¯(ã¡)| æ€»ä»·(ä¸‡) | å•ä»·(ä¸‡/ã¡) | æˆäº¤å‘¨æœŸ | è¯¦æƒ…     |   |
| +------+------------+--------+------+-----------+---------+----------+-------------+----------+----------+ |
| | æˆäº¤ | ç†æƒ³å›½é™…   | 3å®¤2å… | å—åŒ— | é«˜æ¥¼å±‚/18 | 121.0   | 1080     | 8.93        | 56å¤©     | [ æŸ¥çœ‹ ] | |
| | åœ¨å”® | é˜³å…‰éƒ½å¸‚   | 2å®¤1å… | å—   | ä¸­æ¥¼å±‚/28 | 89.5    | 750      | 8.38        | -        | [ æŸ¥çœ‹ ] | |
| | ...  | ...        | ...    | ...  | ...       | ...     | ...      | ...         | ...      | [ æŸ¥çœ‹ ] | |
| |      <------------------------- è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿæ»šåŠ¨åŒºåŸŸï¼Œå¯æµç•…å±•ç¤ºä¸‡æ¡æ•°æ® -------------------------->   | |
+------+------------+--------+------+-----------+---------+----------+-------------+----------+----------+ |
+----------------------------------------------------------------------------------------------------------+
| é¡µç : [ 1 ] 2 3 ... 150  |  å…± 7500 æ¡è®°å½•                                                                |
+----------------------------------------------------------------------------------------------------------+
```

**è¯¦æƒ…æŸ¥çœ‹æ¨¡æ€æ¡† (ç‚¹å‡» `[ æŸ¥çœ‹ ]` æŒ‰é’®åå¼¹å‡º)**
```text
+--------------------------------------------------------------------------+
|                      æˆ¿æºè¯¦æƒ…: ç†æƒ³å›½é™… - 3å®¤2å…                       [X] |
|--------------------------------------------------------------------------|
|                                                                          |
|  [ åŸºç¡€ä¿¡æ¯ ]                                                            |
|    æ•°æ®æ¥æº: lianjia                  ä¸Šæ¸¸æˆ¿æºID: BJ_HD_12345            |
|    ç‰©ä¸šç±»å‹: ä½å®…                     å»ºç­‘å¹´ä»£: 2008                     |
|    å»ºç­‘é¢ç§¯: 121.0 ã¡                 å¥—å†…é¢ç§¯: 98.5 ã¡                  |
|    åŸå§‹æ¥¼å±‚: é«˜æ¥¼å±‚/å…±18å±‚              è£…ä¿®: ç²¾è£…                         |
|                                                                          |
|  [ ä»·æ ¼ä¸æ—¶é—´ ]                                                          |
|    çŠ¶æ€:     æˆäº¤                     æˆäº¤æ€»ä»·: 1080 ä¸‡                  |
|    æŒ‚ç‰Œæ€»ä»·: 1100 ä¸‡                  æˆäº¤æ—¥æœŸ: 2025-10-20               |
|    æˆäº¤å‘¨æœŸ: 56 å¤©                                                       |
|                                                                          |
|  ... (æ­¤å¤„å±•ç¤ºè¯¥æˆ¿æºçš„æ‰€æœ‰éç©ºå­—æ®µ)                                      |
|                                                                          |
+--------------------------------------------------------------------------+
```

**ä¸Šä¼ é¡µ (`/upload`)**
```text
+--------------------------------------------------------------------------------------------------+
| Profo æˆ¿äº§æ•°æ®ä¸­å¿ƒ                                                 [ ä¸»é¡µ ] [ ä¸Šä¼  ] [ æ•°æ®æ²»ç† ]          |
+--------------------------------------------------------------------------------------------------+
| [ æ–‡ä»¶ä¸Šä¼  FileUpload.vue ]                                                                      |
|                           +----------------------------------------------+                       |
|                           |                                              |                       |
|                           |   å°† CSV æ–‡ä»¶æ‹–æ‹½è‡³æ­¤åŒºåŸŸ                      |                       |
|                           |   æˆ–                                         |                       |
|                           |   [ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ ]                           |                       |
|                           |                                              |                       |
|                           +----------------------------------------------+                       |
|                                                                                                  |
|   <!-- ä¸Šä¼ ä¸­ -->                                                                                |
|   ä¸Šä¼  `my_data.csv`... [========================>      ] 75%                                   |
|                                                                                                  |
|   <!-- ä¸Šä¼ å®Œæˆ -->                                                                              |
|   âœ”ï¸ ä¸Šä¼ å®Œæˆ. æ€»è®¡: 1000, æˆåŠŸ: 998, å¤±è´¥: 2. [ ä¸‹è½½å¤±è´¥è®°å½•.csv ]                             |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+
```
**å°åŒºæ•°æ®æ²»ç†é¡µ (`/admin/community-merge`)**
```text
+----------------------------------------------------------------------------------------------------------+
| Profo æˆ¿äº§æ•°æ®ä¸­å¿ƒ                                                 [ ä¸»é¡µ ] [ ä¸Šä¼  ] [ æ•°æ®æ²»ç† ]          |
+----------------------------------------------------------------------------------------------------------+
| [ å°åŒºæ•°æ®æ²»ç† ]                                                                                         |
+----------------------------------------------------------------------------------------------------------+
| [ å·¦ä¾§: å¾…åˆå¹¶å°åŒºåˆ—è¡¨ ]                                 | [ å³ä¾§: åˆå¹¶æ“ä½œå° ]                                |
|----------------------------------------------------------|--------------------------------------------------|
| æœç´¢å°åŒºå: [ "ç†æƒ³å›½é™…"_______________ ] [ ğŸ” æœç´¢ ]     | è¯·ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹© 2 ä¸ªæˆ–ä»¥ä¸Šçš„å°åŒºè¿›è¡Œåˆå¹¶ã€‚        |
|                                                          |                                                  |
| |   | å°åŒºå (ID)         | æˆ¿æºæ•° |                   | [ å·²é€‰æ‹©çš„å°åŒº (ç­‰å¾…æŒ‡å®šä¸»è®°å½•) ]                |
| +---+---------------------+--------+                   |                                                  |
| | âœ“ | ç†æƒ³å›½é™… (ID: 15)   | 120    |                   | +------------------------------------------------+ |
| |   | é˜³å…‰éƒ½å¸‚ (ID: 21)   | 98     |                   | | (*) ç†æƒ³å›½é™… (ID: 15) - 120å¥—æˆ¿æº            | |
| | âœ“ | ç†æƒ³å›½é™…å¤§å¦ (ID:88)| 8      |                   | | ( ) ç†æƒ³å›½é™…å¤§å¦ (ID: 88) - 8å¥—æˆ¿æº          | |
| |   | ä¸–çºªå˜‰å›­ (ID: 33)   | 75     |                   | +------------------------------------------------+ |
|                                                          |   (*) ä»£è¡¨å°†ä½œä¸ºä¸»è®°å½•ä¿ç•™                       |
|                                                          |                                                  |
|                                                          |  [ âš ï¸ ç¡®è®¤åˆå¹¶ ] (é€‰æ‹©ä¸»è®°å½•åæ¿€æ´»)             |
+----------------------------------------------------------------------------------------------------------+
```

---

### **5. åç«¯è¯¦ç»†è®¾è®¡**

#### **5.1 æ ¸å¿ƒæ•°æ®å¥‘çº¦ï¼šç»Ÿä¸€è¾“å…¥æ¨¡å‹**

è¿™æ˜¯ç³»ç»Ÿæ•°æ®è´¨é‡çš„å®ˆé—¨å‘˜ã€‚æ‰€æœ‰å…¥å£æ•°æ®éƒ½å¿…é¡»é€šè¿‡æ­¤ Pydantic æ¨¡å‹çš„æ ¡éªŒã€‚

```python
# æ–‡ä»¶ä½ç½®: backend/schemas.py
import enum
from datetime import datetime
from typing import Optional
from pydantic import BaseModel, Field, root_validator

class IngestionStatus(str, enum.Enum):
    FOR_SALE = "åœ¨å”®"
    SOLD = "æˆäº¤"

class PropertyIngestionModel(BaseModel):
    # --- æ ¸å¿ƒå”¯ä¸€æ ‡è¯† (å§‹ç»ˆå¿…å¡«) ---
    data_source: str = Field(..., alias="æ•°æ®æº")
    source_property_id: str = Field(..., alias="æˆ¿æºID")

    # --- æ ¸å¿ƒä¸šåŠ¡å­—æ®µ (å§‹ç»ˆå¿…å¡«) ---
    status: IngestionStatus = Field(..., alias="çŠ¶æ€")
    community_name: str = Field(..., alias="å°åŒºå")
    rooms: int = Field(..., ge=0, alias="å®¤")
    orientation: str = Field(..., alias="æœå‘")
    floor_original: str = Field(..., alias="æ¥¼å±‚")
    build_area: float = Field(..., gt=0, alias="é¢ç§¯")

    # --- åŠ¨æ€å¿…å¡«å­—æ®µ (æ ¹æ® 'status' å†³å®š) ---
    listed_price_wan: Optional[float] = Field(None, gt=0, alias="æŒ‚ç‰Œä»·(ä¸‡)")
    sold_price_wan: Optional[float] = Field(None, gt=0, alias="æˆäº¤ä»·(ä¸‡)")
    listed_date: Optional[datetime] = Field(None, alias="ä¸Šæ¶æ—¶é—´")
    sold_date: Optional[datetime] = Field(None, alias="æˆäº¤æ—¶é—´")

    # --- å…¶ä»–æ²¿ç”¨çš„éå¿…å¡«å­—æ®µ ---
    halls: int = Field(0, ge=0, alias="å…")
    baths: int = Field(0, ge=0, alias="å«")
    # ... å…¶ä»–å¯é€‰å­—æ®µ

    # --- æ ¸å¿ƒæ ¡éªŒé€»è¾‘ï¼šåŠ¨æ€éªŒè¯ ---
    @root_validator
    def validate_fields_based_on_status(cls, values):
        status = values.get('status')
        if not status:
            return values

        if status == IngestionStatus.FOR_SALE:
            if values.get('listed_price_wan') is None:
                raise ValueError("å½“çŠ¶æ€ä¸º'åœ¨å”®'æ—¶, 'æŒ‚ç‰Œä»·(ä¸‡)' ä¸èƒ½ä¸ºç©º")
            if values.get('listed_date') is None:
                raise ValueError("å½“çŠ¶æ€ä¸º'åœ¨å”®'æ—¶, 'ä¸Šæ¶æ—¶é—´' ä¸èƒ½ä¸ºç©º")
        elif status == IngestionStatus.SOLD:
            if values.get('sold_price_wan') is None:
                raise ValueError("å½“çŠ¶æ€ä¸º'æˆäº¤'æ—¶, 'æˆäº¤ä»·(ä¸‡)' ä¸èƒ½ä¸ºç©º")
            if values.get('sold_date') is None:
                raise ValueError("å½“çŠ¶æ€ä¸º'æˆäº¤'æ—¶, 'æˆäº¤æ—¶é—´' ä¸èƒ½ä¸ºç©º")
        return values

class Config:
    anystr_strip_whitespace = True # è‡ªåŠ¨å»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯ç©ºæ ¼
```

#### **5.2 æ•°æ®åº“æ¨¡å‹**

æ•°æ®åº“è¡¨ç»“æ„å®šä¹‰åœ¨ `backend/models.py` ä¸­ï¼Œ**è¯·ç›´æ¥ä½¿ç”¨åŸå§‹ PRD v4.0 ä¸­æä¾›çš„å®Œæ•´ä»£ç **ã€‚æ ¸å¿ƒè¡¨åŒ…æ‹¬ï¼š`Community`, `CommunityAlias`, `Property`, `PropertyHistory`, `PropertyMedia`, `FailedRecord`ã€‚

```python

# backend/models.py

from sqlalchemy import (

Â  Â  Column, Integer, String, Float, DateTime, Text, Boolean, UniqueConstraint, Index, ForeignKey

)

from sqlalchemy.orm import declarative_base, sessionmaker

from pathlib import Path

import enum

  

Base = declarative_base()

  

# é€šç”¨æšä¸¾

class BusinessType(str, enum.Enum):

Â  Â  buy = "buy"

Â  Â  # rent = "rent" Â # é¢„ç•™

  

class Status(str, enum.Enum):

Â  Â  active = "active"

Â  Â  inactive = "inactive"

  

class ChangeType(str, enum.Enum):

Â  Â  price_change = "price_change"

Â  Â  status_change = "status_change"

Â  Â  info_change = "info_change"

  

class MediaType(str, enum.Enum):

Â  Â  layout = "layout"

Â  Â  indoor = "indoor"

  

# ---------------- 1. å°åŒºå­—å…¸ ----------------

class Community(Base):

Â  Â  """communities å°åŒºå­—å…¸"""

Â  Â  __tablename__ = "communities"

Â  Â  id = Column(Integer, primary_key=True, autoincrement=True,

Â  Â  Â  Â  Â  Â  Â  Â  comment="å°åŒºæ ‡å‡†IDï¼ˆç³»ç»Ÿè‡ªå¢ï¼Œå”¯ä¸€æ ‡è¯†ï¼‰")

Â  Â  city_id = Column(Integer, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="åŸå¸‚IDï¼ˆå…³è”åŸå¸‚å­—å…¸è¡¨ï¼Œç”¨äºåŸå¸‚çº§ç»Ÿè®¡ï¼‰")

Â  Â  name = Column(String, nullable=False, unique=True,

Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æ ‡å‡†åŒ–å°åŒºåï¼ˆç»Ÿä¸€å‘½åï¼Œæ¶ˆé™¤åˆ«åå·®å¼‚ï¼‰")

Â  Â  district = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="è¡Œæ”¿åŒºï¼ˆå¦‚\"æµ·æ·€åŒº\"ï¼Œç»Ÿè®¡ç”¨ï¼‰")

Â  Â  business_circle = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å•†åœˆï¼ˆå¦‚\"ä¸­å…³æ‘\"ï¼Œç²¾å‡†å®šä½æ¿å—ï¼‰")

Â  Â  address = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="è¯¦ç»†åœ°å€ï¼ˆåŸå§‹åœ°å€ï¼Œç”¨äºå±•ç¤ºï¼‰")

Â  Â  latitude = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="çº¬åº¦ï¼ˆåœ°å›¾ç»„ä»¶ç”¨ï¼Œå¯ä¸ºNULLï¼‰")

Â  Â  longitude = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="ç»åº¦ï¼ˆåœ°å›¾ç»„ä»¶ç”¨ï¼Œå¯ä¸ºNULLï¼‰")

Â  Â  total_buildings = Column(Integer, default=0,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æ¥¼æ ‹æ€»æ•°ï¼ˆè‡ªåŠ¨ç»Ÿè®¡æˆ–äººå·¥ç»´æŠ¤ï¼‰")

Â  Â  total_households = Column(Integer, default=0,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æ€»æˆ·æ•°ï¼ˆè‡ªåŠ¨ç»Ÿè®¡æˆ–äººå·¥ç»´æŠ¤ï¼‰")

Â  Â  property_company = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="ç‰©ä¸šå…¬å¸åç§°ï¼ˆå±•ç¤ºç”¨ï¼‰")

Â  Â  green_rate = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="ç»¿åŒ–ç‡ï¼ˆ0-1ï¼Œå¦‚0.35è¡¨ç¤º35%ï¼‰")

Â  Â  avg_price_wan = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å°åŒºå‡ä»·ï¼ˆä¸‡å…ƒ/å¹³ï¼Œè®¡ç®—é€»è¾‘å¾…å®šï¼‰")

Â  Â  total_properties = Column(Integer, default=0,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å½“å‰åœ¨å”®æˆ¿æºæ•°ï¼ˆå®æ—¶ç»Ÿè®¡ï¼‰")

Â  Â  status = Column(String, default=Status.active,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="activeï¼ˆæ­£å¸¸ï¼‰/inactiveï¼ˆå·²ç¦ç”¨ï¼‰")

Â  Â  created_at = Column(DateTime, server_default="now()",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å°åŒºé¦–æ¬¡å…¥åº“æ—¶é—´")

Â  Â  updated_at = Column(DateTime, server_default="now()",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æœ€åæ›´æ–°æ—¶é—´")

Â  Â  created_by = Column(Integer,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="åˆ›å»ºäººIDï¼ˆç°åœ¨ä¸ºNULLï¼ŒåæœŸå¡«user_idï¼‰")

  

# ---------------- 2. å°åŒºåˆ«åæ˜ å°„ ----------------

class CommunityAlias(Base):

Â  Â  """community_aliases å°åŒºåˆ«åæ˜ å°„"""

Â  Â  __tablename__ = "community_aliases"

Â  Â  id = Column(Integer, primary_key=True, autoincrement=True,

Â  Â  Â  Â  Â  Â  Â  Â  comment="åˆ«åè®°å½•ID")

Â  Â  community_id = Column(Integer, ForeignKey("communities.id"), nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å…³è”çš„æ ‡å‡†å°åŒºIDï¼ˆå¤–é”®ï¼‰")

Â  Â  alias_name = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="åˆ«åï¼ˆå¦‚\"ä¸­å…³æ‘å¤§è¡—ä½å®…å°åŒº\"ï¼‰")

Â  Â  data_source = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="è¯¥åˆ«åæ¥è‡ªå“ªä¸ªå¹³å°ï¼ˆbeike/lianjiaï¼‰")

Â  Â  created_at = Column(DateTime, server_default="now()",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="åˆ«åé¦–æ¬¡å‡ºç°æ—¶é—´")

Â  Â  __table_args__ = (UniqueConstraint("alias_name", "data_source"), )

  

# ---------------- 3. æˆ¿æºå½“å‰çŠ¶æ€ ----------------

class Property(Base):

Â  Â  """property_current æˆ¿æºå½“å‰çŠ¶æ€ï¼ˆä¹°å–æ ¸å¿ƒï¼‰"""

Â  Â  __tablename__ = "property_current"

Â  Â  id = Column(Integer, primary_key=True, autoincrement=True,

Â  Â  Â  Â  Â  Â  Â  Â  comment="æˆ¿æºå†…éƒ¨IDï¼ˆè‡ªå¢ï¼‰")

Â  Â  source_property_id = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="ä¸Šæ¸¸æˆ¿æºIDï¼ˆå¹³å°å†…å”¯ä¸€ï¼Œå¦‚\"BJ_HD_12345\"ï¼‰")

Â  Â  data_source = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æ•°æ®æ¥æºå¹³å°ï¼ˆbeike/lianjia/58ï¼‰")

Â  Â  business_type = Column(String, default=BusinessType.buy, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="ä¸šåŠ¡ç±»å‹ï¼ˆbuy=ä¹°å–ï¼Œé¢„ç•™rent=ç§Ÿèµï¼‰")

Â  Â  community_id = Column(Integer, ForeignKey("communities.id"),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æ‰€å±å°åŒºIDï¼ˆå…³è”communitiesè¡¨ï¼‰")

Â  Â  source_id = Column(Integer,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å¹³å°å†…éƒ¨IDï¼ˆå¤‡ç”¨å­—æ®µï¼‰")

Â  Â  rooms = Column(Integer, default=0, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å®¤æ•°é‡ï¼ˆ0è¡¨ç¤ºå¼€é—´ï¼Œç”¨äºç­›é€‰ï¼‰")

Â  Â  halls = Column(Integer, default=0, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å…æ•°é‡ï¼ˆ0è¡¨ç¤ºæ— å…ï¼‰")

Â  Â  baths = Column(Integer, default=0, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å«æ•°é‡ï¼ˆ0è¡¨ç¤ºæ— å«ï¼‰")

Â  Â  build_area = Column(Float, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å»ºç­‘é¢ç§¯ï¼ˆå¹³ç±³ï¼Œæ ¸å¿ƒç­›é€‰æ¡ä»¶ï¼‰")

Â  Â  usable_area = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å¥—å†…é¢ç§¯ï¼ˆå¹³ç±³ï¼Œå¯é€‰ï¼Œç”¨äºå¾—æˆ¿ç‡è®¡ç®—ï¼‰")

Â  Â  orientation = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æœå‘ï¼ˆå—/åŒ—/ä¸œ/è¥¿/å—åŒ—ï¼Œå½±å“é‡‡å…‰ä¼°å€¼ï¼‰")

Â  Â  floor_original = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="åŸå§‹æ¥¼å±‚å­—ç¬¦ä¸²ï¼ˆä¿ç•™ä¸Šæ¸¸åŸå§‹å€¼ï¼Œç”¨äºå±•ç¤ºï¼‰")

Â  Â  floor_number = Column(Integer,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="è§£æå‡ºçš„æ¥¼å±‚æ•°å­—ï¼ˆå¦‚15å±‚ï¼Œç”¨äºè®¡ç®—floor_levelï¼‰")

Â  Â  total_floors = Column(Integer,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æ€»å±‚é«˜ï¼ˆå¦‚28å±‚ï¼Œç”¨äºè®¡ç®—floor_levelï¼‰")

Â  Â  floor_level = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æ™ºèƒ½çº§åˆ«ï¼ˆä½æ¥¼å±‚/ä¸­æ¥¼å±‚/é«˜æ¥¼å±‚ï¼Œè‡ªåŠ¨è®¡ç®—ï¼‰")

Â  Â  build_year = Column(Integer,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å»ºç­‘å¹´ä»£ï¼ˆå¦‚2005ï¼Œæˆ¿é¾„=å½“å‰å¹´ä»½-build_yearï¼‰")

Â  Â  property_type = Column(String, default="ä½å®…",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="ç‰©ä¸šç±»å‹ï¼ˆä½å®…/å…¬å¯“/åˆ«å¢…/å•†é“ºï¼Œå½±å“è´·æ¬¾æ”¿ç­–ï¼‰")

Â  Â  renovation_status = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="è£…ä¿®çŠ¶æ€ï¼ˆæ¯›å¯/ç®€è£…/ç²¾è£…/è±ªè£…ï¼Œå½±å“è®®ä»·ç©ºé—´ï¼‰")

Â  Â  listed_price_wan = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æŒ‚ç‰Œæ€»ä»·ï¼ˆä¸‡å…ƒï¼Œæ ¸å¿ƒæŒ‡æ ‡ï¼Œç²¾ç¡®åˆ°å°æ•°ç‚¹å2ä½ï¼‰")

Â  Â  listed_date = Column(DateTime,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æŒ‚ç‰Œæ—¶é—´ï¼ˆè®¡ç®—æˆäº¤å‘¨æœŸçš„èµ·ç‚¹ï¼‰")

Â  Â  sold_price_wan = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æˆäº¤æ€»ä»·ï¼ˆä¸‡å…ƒï¼Œæˆäº¤åå›å¡«ï¼‰")

Â  Â  sold_date = Column(DateTime,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æˆäº¤æ—¶é—´ï¼ˆæˆäº¤åå›å¡«ï¼‰")

Â  Â  transaction_duration_days = Column(Integer,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æˆäº¤å‘¨æœŸï¼ˆå¤©ï¼Œ=sold_date - listed_dateï¼‰")

Â  Â  online_signed_price_wan = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="ç½‘ç­¾ä»·ï¼ˆä¸‡å…ƒï¼Œç”¨äºç¨è´¹è®¡ç®—ï¼‰")

Â  Â  transaction_type = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="äº¤æ˜“ç±»å‹ï¼ˆå…¨æ¬¾/å•†è´·/å…¬ç§¯é‡‘/ç»„åˆè´·ï¼Œå½±å“é¦–ä»˜æ¯”ä¾‹ï¼‰")

Â  Â  rent_price_monthly = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æœˆç§Ÿé‡‘ï¼ˆå…ƒï¼Œå¯é€‰ï¼Œç”¨äºè®¡ç®—ç§Ÿå”®æ¯”ï¼‰")

Â  Â  url = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æˆ¿æºé“¾æ¥ï¼ˆåŸå§‹é“¾æ¥ï¼Œç”¨äºè·³è½¬éªŒè¯ï¼‰")

Â  Â  layout_url = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æˆ·å‹å›¾é“¾æ¥ï¼ˆçŸ­æœŸè¿‡æ¸¡å­—æ®µï¼ŒåæœŸè¿ç§»åˆ°property_mediaï¼‰")

Â  Â  tags = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æˆ¿æºæ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚\"æ»¡äº”å”¯ä¸€,è¿‘åœ°é“,æ€¥å”®\"ï¼‰")

Â  Â  mortgage_info = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æŠµæŠ¼ä¿¡æ¯ï¼ˆå¦‚æœ‰æŠµæŠ¼ï¼Œç”¨äºé£é™©æç¤ºï¼‰")

Â  Â  extra_info = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="JSONå­—ç¬¦ä¸²ï¼ˆå­˜å‚¨å¹³å°ç‰¹æœ‰å­—æ®µï¼Œå¦‚\"æ¢¯æˆ·æ¯”\":\"2æ¢¯4æˆ·\"ï¼‰")

Â  Â  created_at = Column(DateTime, server_default="now()",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æˆ¿æºé¦–æ¬¡å…¥åº“æ—¶é—´")

Â  Â  updated_at = Column(DateTime, server_default="now()",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æœ€åæ›´æ–°æ—¶é—´ï¼ˆä»·æ ¼å˜åŒ–æˆ–çŠ¶æ€å˜åŒ–æ—¶åˆ·æ–°ï¼‰")

Â  Â  owner_id = Column(Integer,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æ•°æ®å½’å±ç”¨æˆ·IDï¼ˆç°åœ¨ä¸ºNULLï¼ŒåæœŸç™»å½•åå¡«å……ï¼‰")

Â  Â  visibility = Column(String, default="public",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å¯è§æ€§ï¼ˆpublic=å…¬å¼€/private=ç§æœ‰/team=å›¢é˜Ÿå…±äº«ï¼‰")

Â  Â  is_active = Column(Boolean, default=True,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="è½¯åˆ é™¤æ ‡è®°ï¼ˆTrue=æœ‰æ•ˆ/False=å·²åˆ é™¤ï¼Œç‰©ç†ä¸åˆ é™¤ï¼‰")

Â  Â  __table_args__ = (UniqueConstraint("data_source", "source_property_id"),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Index("idx_community_price", "community_id", "listed_price_wan"),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Index("idx_owner_visibility", "owner_id", "visibility"), )

  

# ---------------- 4. æˆ¿æºå†å²å¿«ç…§ ----------------

class PropertyHistory(Base):

Â  Â  """property_history å†å²å¿«ç…§ï¼ˆä»·æ ¼ä¸çŠ¶æ€å˜æ›´ï¼‰"""

Â  Â  __tablename__ = "property_history"

Â  Â  id = Column(Integer, primary_key=True, autoincrement=True,

Â  Â  Â  Â  Â  Â  Â  Â  comment="å†å²è®°å½•ID")

Â  Â  source_property_id = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="ä¸Šæ¸¸æˆ¿æºIDï¼ˆå…³è”property_currentï¼‰")

Â  Â  data_source = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æ•°æ®æ¥æºå¹³å°")

Â  Â  business_type = Column(String, default=BusinessType.buy, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="ä¸šåŠ¡ç±»å‹ï¼ˆå½“å‰ä»…buyï¼‰")

Â  Â  change_type = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å˜æ›´ç±»å‹ï¼ˆprice_change=ä»·æ ¼å˜/status_change=çŠ¶æ€å˜/info_change=ä¿¡æ¯å˜ï¼‰")

Â  Â  listed_price_wan = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å½“æ—¶çš„æŒ‚ç‰Œä»·")

Â  Â  sold_price_wan = Column(Float,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å½“æ—¶çš„æˆäº¤ä»·ï¼ˆå¦‚å·²æˆäº¤ï¼‰")

Â  Â  status = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å½“æ—¶çš„çŠ¶æ€ï¼ˆfor_sale/sold/withdrawnï¼‰")

Â  Â  captured_at = Column(DateTime, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å¿«ç…§ç”Ÿæˆæ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰")

Â  Â  change_reason = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å˜æ›´åŸå› ï¼ˆç”¨æˆ·è°ƒä»·/è‡ªåŠ¨ä¸‹æ¶/æˆäº¤ï¼‰")

Â  Â  __table_args__ = (Index("idx_history_lookup", "data_source", "source_property_id", "captured_at DESC"), )

  

# ---------------- 5. åª’ä½“èµ„æº ----------------

class PropertyMedia(Base):

Â  Â  """property_media æˆ¿æºåª’ä½“èµ„æº"""

Â  Â  __tablename__ = "property_media"

Â  Â  id = Column(Integer, primary_key=True, autoincrement=True,

Â  Â  Â  Â  Â  Â  Â  Â  comment="åª’ä½“èµ„æºID")

Â  Â  source_property_id = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="ä¸Šæ¸¸æˆ¿æºID")

Â  Â  data_source = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æ•°æ®æ¥æºå¹³å°")

Â  Â  media_type = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="åª’ä½“ç±»å‹ï¼ˆlayout=æˆ·å‹å›¾/indoor=å®¤å†…å›¾ï¼‰")

Â  Â  url = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å›¾ç‰‡URLï¼ˆåŸå§‹é“¾æ¥ï¼‰")

Â  Â  sort_order = Column(Integer, default=0,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æ’åºæƒé‡ï¼ˆè¶Šå°è¶Šé å‰ï¼‰")

Â  Â  created_at = Column(DateTime, server_default="now()",

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å…¥åº“æ—¶é—´")

Â  Â  __table_args__ = (UniqueConstraint("data_source", "source_property_id", "url"),

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Index("idx_property_media", "source_property_id", "data_source", "media_type"), )

  

# ---------------- 6. å¤±è´¥æ”¶å®¹æ‰€ ----------------

class FailedRecord(Base):

Â  Â  """failed_records å¤±è´¥æ”¶å®¹æ‰€ï¼ˆé›¶ä¸¢å¤±ä¿éšœï¼‰"""

Â  Â  __tablename__ = "failed_records"

Â  Â  id = Column(Integer, primary_key=True, autoincrement=True,

Â  Â  Â  Â  Â  Â  Â  Â  comment="å¤±è´¥è®°å½•ID")

Â  Â  data_source = Column(String,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="æ•°æ®æ¥æºï¼ˆä¾¿äºå½’ç±»ï¼‰")

Â  Â  payload = Column(Text, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="åŸå§‹æ•°æ®å…¨æ–‡ï¼ˆJSONæˆ–CSVè¡Œï¼Œç”¨äºäººå·¥å¤ç›˜ï¼‰")

Â  Â  failure_type = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="å¤±è´¥ç±»å‹ï¼ˆvalidation_error=éªŒè¯å¤±è´¥/parse_error=è§£æå¤±è´¥/db_error=æ•°æ®åº“é”™è¯¯ï¼‰")

Â  Â  failure_reason = Column(String, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚\"å¿…å¡«å­—æ®µç¼ºå¤±: build_area\"ï¼‰")

Â  Â  occurred_at = Column(DateTime, nullable=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comment="å¤±è´¥å‘ç”Ÿæ—¶é—´")

Â  Â  is_handled = Column(Boolean, default=False,

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comment="æ˜¯å¦å·²äººå·¥å¤„ç†ï¼ˆFalse=å¾…å¤„ç†/True=å·²å¤„ç†ï¼‰")

Â  Â  __table_args__ = (Index("idx_unhandled", "data_source", "is_handled", "occurred_at"), )

  
  

# ============== æ•°æ®åº“åˆå§‹åŒ– ==============

def create_all():

Â  Â  from sqlalchemy import create_engine

Â  Â  DB_FILE = Path(__file__).parent / "data.db"

Â  Â  engine = create_engine(f"sqlite:///{DB_FILE}?check_same_thread=False", echo=False)

Â  Â  Base.metadata.create_all(bind=engine)

Â  Â  return engine

```

  



#### **5.3 API æ¥å£æ¸…å•**

| è·¯ç”± | æ–¹æ³• | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- |
| `/api/upload/csv` | POST | ä¸Šä¼  CSV æ–‡ä»¶ï¼Œå¼‚æ­¥å¤„ç†ã€‚ |
| `/api/push` | POST | æ¥æ”¶æˆ¿æº JSON æ•°ç»„ï¼ŒåŒæ­¥å¤„ç†ã€‚ |
| `/api/properties` | GET | æŸ¥è¯¢æˆ¿æºåˆ—è¡¨ï¼Œæ”¯æŒçŠ¶æ€ã€ä»·æ ¼ã€é¢ç§¯ç­‰å¤šç»´åº¦ç­›é€‰ã€æ’åºå’Œåˆ†é¡µã€‚ |
| `/api/properties/export` | GET | å¯¼å‡ºä¸æŸ¥è¯¢æ¡ä»¶ä¸€è‡´çš„ CSV æ–‡ä»¶ã€‚ |
| `/api/admin/communities`| GET | è·å–å°åŒºåˆ—è¡¨ï¼Œç”¨äºæ²»ç†é¡µé¢ã€‚ |
| `/api/admin/communities/merge` | POST | **(æ–°å¢)** æ‰§è¡Œå°åŒºåˆå¹¶æ“ä½œã€‚ |

---

### **6. éƒ¨ç½²ä¸å¯åŠ¨**

#### **6.1 ç¯å¢ƒå‡†å¤‡**

1.  ç¡®ä¿å·²å®‰è£… Python 3.10+, Node.js (LTS), à¹à¸¥à¸° pnpmã€‚
2.  å®‰è£… `uv`ï¼š`pip install uv`ã€‚
3.  **å®‰è£…åç«¯ä¾èµ–**: åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ `uv sync --python=3.10` (æ ¹æ®ä½ çš„Pythonç‰ˆæœ¬)ã€‚
4.  **å®‰è£…å‰ç«¯ä¾èµ–**: åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ `pnpm install`ã€‚

#### **6.2 ä¸€é”®å¯åŠ¨è„šæœ¬**

é¡¹ç›®æ ¹ç›®å½•æä¾›äº† `start.bat` (Windows) å’Œ `start.sh` (macOS/Linux) è„šæœ¬ã€‚

**`start.sh` ç¤ºä¾‹:**
```bash
#!/bin/bash
echo "æ­£åœ¨å¯åŠ¨ Profo æˆ¿äº§æ•°æ®ä¸­å¿ƒ..."
# æ•æ‰ Ctrl+C ä¿¡å·ï¼Œå¹¶ç»“æŸæ‰€æœ‰åå°ä»»åŠ¡
trap "echo 'æ­£åœ¨åœæ­¢æ‰€æœ‰æœåŠ¡...'; pkill -f 'uv run main.py'; pkill -f 'pnpm dev'; exit 0" INT

echo "[1/2] æ­£åœ¨å¯åŠ¨åç«¯æœåŠ¡..."
(cd backend && uv run main.py) &

echo "[2/2] æ­£åœ¨å¯åŠ¨å‰ç«¯æœåŠ¡..."
(cd frontend && pnpm dev) &

echo "==========================="
echo "åç«¯ (FastAPI) è¿è¡Œäº http://localhost:8000"
echo "å‰ç«¯ (Vue)    è¿è¡Œäº http://localhost:3000"
echo "æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœåŠ¡"
echo "==========================="

# ç­‰å¾…æ‰€æœ‰åå°è¿›ç¨‹ç»“æŸ
wait
```
åŒå‡»æˆ–åœ¨ç»ˆç«¯è¿è¡Œç›¸åº”è„šæœ¬ï¼Œå³å¯åŒæ—¶å¯åŠ¨å‰åç«¯å¼€å‘æœåŠ¡å™¨ã€‚

---

è¿™ä»½æ–‡æ¡£æ˜¯æ‚¨å¼€å‘ Profo v4.0 é¡¹ç›®çš„èµ·ç‚¹å’ŒæŒ‡å—ã€‚ç¥æ‚¨å¼€å‘é¡ºåˆ©ï¼