# API 推送文档

## 注意事项
- 标有<span style="color:red">*</span>的字段为必填项（仅用于文档标识，实际推送请勿包含星号或注释）
- 未提供必填字段时返回 `VALIDATION_ERROR`，`error.details` 会列出缺失字段
- 格式与验证规则：
  - `面积` > 0；`挂牌价`/`成交价` > 0（单位：万）
  - 时间字段为 ISO 格式：`YYYY-MM-DDTHH:MM:SS`
  - 在售必须提供 `挂牌价` 与 `上架时间`；成交必须提供 `成交价` 与 `成交时间`

## 接口概览
- 路径：`POST /api/push`
- 功能：批量推送房源 JSON 数据，支持在售与成交两类状态
- 请求体：JSON 数组，每个元素为一条房源记录（支持中文字段别名）
- 响应：统计结果与错误详情

## 请求格式
- 内容类型：`application/json`
- 价格单位：`万`（例如 `挂牌价: 500.0` 表示 500 万）
- 必填字段（按状态动态要求）：
  - 在售（`状态: "在售"`）必须包含 `挂牌价`、`上架时间`
  - 成交（`状态: "成交"`）必须包含 `成交价`、`成交时间`

### 字段列表（全部支持字段）

| 参数 | 说明 | 必填 |
|---|---|---|
| 数据源 | 数据来源平台 | 是 |
| 房源ID | 来源平台房源ID | 是 |
| 状态 | 在售/成交 | 是 |
| 小区名 | 小区名称 | 是 |
| 室 | 室数量 | 是 |
| 厅 | 厅数量 | 否 |
| 卫 | 卫生间数量 | 否 |
| 朝向 | 房屋朝向 | 是 |
| 楼层 | 原始楼层字符串 | 是 |
| 面积 | 建筑面积(㎡) | 是 |
| 套内面积 | 套内面积(㎡) | 否 |
| 挂牌价 | 在售：挂牌价(万) | 是(在售) |
| 上架时间 | 在售：上架时间 | 是(在售) |
| 成交价 | 成交：成交价(万) | 是(成交) |
| 成交时间 | 成交：成交时间 | 是(成交) |
| 物业类型 | 物业类型 | 否 |
| 建筑年代 | 建筑年代 | 否 |
| 建筑结构 | 建筑结构 | 否 |
| 装修情况 | 装修情况 | 否 |
| 电梯 | 是否有电梯 | 否 |
| 产权性质 | 产权性质 | 否 |
| 产权年限 | 产权年限 | 否 |
| 上次交易 | 上次交易信息 | 否 |
| 供暖方式 | 供暖方式 | 否 |
| 房源描述 | 房源描述 | 否 |
| 城市ID | 城市ID | 否 |
| 行政区 | 行政区 | 否 |
| 商圈 | 商圈 | 否 |

说明：后端支持中文别名与英文字段名（已启用别名映射）。

## 推送示例

### 在售房源示例
```jsonc
[
  {
    "数据源": "api_partner", // <span style="color:red">*</span>
    "房源ID": "A001", // <span style="color:red">*</span>
    "状态": "在售", // <span style="color:red">*</span>
    "小区名": "示例小区", // <span style="color:red">*</span>
    "室": 3, // <span style="color:red">*</span>
    "厅": 2,
    "卫": 2,
    "朝向": "南", // <span style="color:red">*</span>
    "楼层": "15/28", // <span style="color:red">*</span>
    "面积": 120.5, // <span style="color:red">*</span>
    "挂牌价": 500.0, // <span style="color:red">*</span> 在售必填
    "上架时间": "2024-01-15T10:00:00" // <span style="color:red">*</span> 在售必填
  }
]
```
- 标注说明：标有<span style="color:red">*</span>的字段为必填项；示例中的注释仅用于文档说明，实际推送请勿包含注释或星号。

验证失败示例响应（缺少在售必填字段）：
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "请求参数验证失败",
    "details": "缺少必填字段: 挂牌价; 缺少必填字段: 上架时间"
  }
}
```

### 成交房源示例
```jsonc
[
  {
    "数据源": "api_partner", // <span style="color:red">*</span>
    "房源ID": "S003", // <span style="color:red">*</span>
    "状态": "成交", // <span style="color:red">*</span>
    "小区名": "示例小区", // <span style="color:red">*</span>
    "室": 3, // <span style="color:red">*</span>
    "厅": 2,
    "卫": 2,
    "朝向": "南北", // <span style="color:red">*</span>
    "楼层": "高楼层/25", // <span style="color:red">*</span>
    "面积": 110.0, // <span style="color:red">*</span>
    "成交价": 480.0, // <span style="color:red">*</span> 成交必填
    "成交时间": "2024-02-15T14:30:00" // <span style="color:red">*</span> 成交必填
  }
]
```
验证失败示例响应（缺少成交必填字段）：
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "请求参数验证失败",
    "details": "缺少必填字段: 成交价; 缺少必填字段: 成交时间"
  }
}
```

### 在售房源完整示例
```json
[
  {
    "数据源": "api_partner",
    "房源ID": "A1001",
    "状态": "在售",
    "小区名": "万科城市花园",
    "城市ID": 310000,
    "行政区": "闵行",
    "商圈": "莘庄",
    "室": 3,
    "厅": 2,
    "卫": 2,
    "朝向": "南",
    "楼层": "15/28",
    "面积": 120.5,
    "套内面积": 98.0,
    "挂牌价": 800.0,
    "上架时间": "2024-01-15T10:00:00",
    "物业类型": "普通住宅",
    "建筑年代": 2015,
    "建筑结构": "框架结构",
    "装修情况": "精装",
    "电梯": true,
    "产权性质": "商品房",
    "产权年限": 70,
    "上次交易": "2020-06-01",
    "供暖方式": "集中供暖",
    "房源描述": "满五唯一，采光好，无遮挡"
  }
]
```

### 成交房源完整示例
```json
[
  {
    "数据源": "api_partner",
    "房源ID": "S2001",
    "状态": "成交",
    "小区名": "保利香槟",
    "城市ID": 310000,
    "行政区": "浦东",
    "商圈": "张江",
    "室": 2,
    "厅": 1,
    "卫": 1,
    "朝向": "东南",
    "楼层": "高楼层/33",
    "面积": 89.0,
    "套内面积": 76.0,
    "成交价": 520.0,
    "成交时间": "2024-03-15T14:30:00",
    "上架时间": "2024-01-20T09:00:00",
    "物业类型": "公寓",
    "建筑年代": 2018,
    "建筑结构": "剪力墙",
    "装修情况": "简装",
    "电梯": true,
    "产权性质": "商品房",
    "产权年限": 70,
    "上次交易": "2021-09-12",
    "供暖方式": "自供暖",
    "房源描述": "学区房，交通便利"
  }
]
```

### Curl 调用示例（Windows PowerShell）
```powershell
curl -X POST "http://localhost:8000/api/push" `
  -H "Content-Type: application/json" `
  -d "[{\"数据源\":\"api_partner\",\"房源ID\":\"A001\",\"状态\":\"在售\",\"小区名\":\"示例小区\",\"室\":3,\"厅\":2,\"卫\":2,\"朝向\":\"南\",\"楼层\":\"15/28\",\"面积\":120.5,\"挂牌价\":500.0,\"上架时间\":\"2024-01-15T10:00:00\"}]"
```

## 响应格式
```json
{
  "total": 3,
  "success": 2,
  "failed": 1,
  "errors": [
    {
      "index": 1,
      "source_property_id": "API_TEST_005",
      "reason": "缺少必填字段: 挂牌价; 缺少必填字段: 上架时间"
    }
  ]
}
```
- 字段含义：
  - `total`：推送的总记录数
  - `success`：成功导入的记录数
  - `failed`：失败的记录数
  - `errors`：失败详情列表（包含数组索引、房源ID、失败原因）

## 错误代码含义
- 错误响应统一结构：
```json
{
  "success": false,
  "error": {
    "code": "...",
    "message": "...",
    "details": "...可选..."
  }
}
```

- 常见错误代码与含义：
  - `VALIDATION_ERROR`
    - 说明：请求体为空、超出单次推送上限、参数或字段验证失败
    - HTTP 状态码：`400` 或 `422`
  - `DUPLICATE_RECORD`
    - 说明：房源已存在（数据源与房源ID重复）或其他唯一性约束冲突
    - HTTP 状态码：`409`
  - `RESOURCE_NOT_FOUND`
    - 说明：目标资源不存在
    - HTTP 状态码：`404`
  - `FILE_PROCESSING_ERROR`
    - 说明：文件处理相关错误
    - HTTP 状态码：`400`
  - `BUSINESS_LOGIC_ERROR`
    - 说明：业务逻辑失败（批量处理失败等）
    - HTTP 状态码：`422`
  - `DATABASE_ERROR`
    - 说明：数据库错误（外键不存在、字段缺失、数据格式错误等）
    - HTTP 状态码：`500`，部分完整性错误可能为 `400`/`409`
  - `HTTP_<status>`
    - 说明：转发的 HTTP 异常，如 `HTTP_404`、`HTTP_500`
    - HTTP 状态码：对应的 `<status>`
  - `INTERNAL_SERVER_ERROR`
    - 说明：未捕获的服务器内部错误；`debug` 模式下会返回详细堆栈
    - HTTP 状态码：`500`

## 开发注意事项
- 在售与成交的必填项需按状态提供，否则将被拒收并记录失败原因
- `面积` 为正数；价格单位为 `万`
- 系统对小区名称做标准化与别名匹配，必要时会自动创建小区记录
- 推送数组长度上限：`10000`

## 相关端点
- 推送：`POST /api/push`
- 列表查询：`GET /api/properties`
- 导出：`GET /api/properties/export`