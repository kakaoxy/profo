# API 推送文档

## 接口概览
- 路径：`POST /api/push`
- 功能：批量推送房源 JSON 数据，支持在售与成交两类状态
- 请求体：JSON 数组，每个元素为一条房源记录（支持中文字段别名）
- 响应：统计结果与错误详情

## 请求格式
- 内容类型：`application/json`
- 价格单位：`万`（例如 `挂牌价: 500.0` 表示 500 万）
- 必填字段（按状态动态要求）：
  - 在售（`状态: "在售"`）必须包含 `挂牌价`、`上架时间`
  - 成交（`状态: "成交"`）必须包含 `成交价`、`成交时间`

### 字段列表（常用）
- 核心标识：`数据源`、`房源ID`
- 状态与小区：`状态`、`小区名`
- 户型：`室`、`厅`、`卫`
- 朝向与楼层：`朝向`、`楼层`
- 面积：`面积`（㎡）、`套内面积`（㎡，可选）
- 价格（万）：`挂牌价`（在售）、`成交价`（成交）
- 时间：`上架时间`（在售）、`成交时间`（成交）
- 其他：`物业类型`、`建筑年代`、`装修情况`、`电梯` 等

## 推送示例

### 在售房源示例
```json
[
  {
    "数据源": "api_partner",
    "房源ID": "A001",
    "状态": "在售",
    "小区名": "示例小区",
    "室": 3,
    "厅": 2,
    "卫": 2,
    "朝向": "南",
    "楼层": "15/28",
    "面积": 120.5,
    "挂牌价": 500.0,
    "上架时间": "2024-01-15T10:00:00",
    "物业类型": "普通住宅",
    "建筑年代": 2015,
    "装修情况": "精装",
    "电梯": true
  }
]
```

### 成交房源示例
```json
[
  {
    "数据源": "api_partner",
    "房源ID": "S003",
    "状态": "成交",
    "小区名": "示例小区",
    "室": 3,
    "厅": 2,
    "卫": 2,
    "朝向": "南北",
    "楼层": "高楼层/25",
    "面积": 110.0,
    "成交价": 480.0,
    "成交时间": "2024-02-15T14:30:00"
  }
]
```

### Curl 调用示例（Windows PowerShell）
```powershell
curl -X POST "http://localhost:8000/api/push" `
  -H "Content-Type: application/json" `
  -d "[{\"数据源\":\"api_partner\",\"房源ID\":\"A001\",\"状态\":\"在售\",\"小区名\":\"示例小区\",\"室\":3,\"厅\":2,\"卫\":2,\"朝向\":\"南\",\"楼层\":\"15/28\",\"面积\":120.5,\"挂牌价\":500.0,\"上架时间\":\"2024-01-15T10:00:00\"}]"
```

## 响应格式
```json
{
  "total": 3,
  "success": 2,
  "failed": 1,
  "errors": [
    {
      "index": 1,
      "source_property_id": "API_TEST_005",
      "reason": "缺少必填字段: 挂牌价; 缺少必填字段: 上架时间"
    }
  ]
}
```
- 字段含义：
  - `total`：推送的总记录数
  - `success`：成功导入的记录数
  - `failed`：失败的记录数
  - `errors`：失败详情列表（包含数组索引、房源ID、失败原因）

## 错误代码含义
- 错误响应统一结构：
```json
{
  "success": false,
  "error": {
    "code": "...",
    "message": "...",
    "details": "...可选..."
  }
}
```

- 常见错误代码与含义：
  - `VALIDATION_ERROR`
    - 说明：请求体为空、超出单次推送上限、参数或字段验证失败
    - HTTP 状态码：`400` 或 `422`
  - `DUPLICATE_RECORD`
    - 说明：房源已存在（数据源与房源ID重复）或其他唯一性约束冲突
    - HTTP 状态码：`409`
  - `RESOURCE_NOT_FOUND`
    - 说明：目标资源不存在
    - HTTP 状态码：`404`
  - `FILE_PROCESSING_ERROR`
    - 说明：文件处理相关错误
    - HTTP 状态码：`400`
  - `BUSINESS_LOGIC_ERROR`
    - 说明：业务逻辑失败（批量处理失败等）
    - HTTP 状态码：`422`
  - `DATABASE_ERROR`
    - 说明：数据库错误（外键不存在、字段缺失、数据格式错误等）
    - HTTP 状态码：`500`，部分完整性错误可能为 `400`/`409`
  - `HTTP_<status>`
    - 说明：转发的 HTTP 异常，如 `HTTP_404`、`HTTP_500`
    - HTTP 状态码：对应的 `<status>`
  - `INTERNAL_SERVER_ERROR`
    - 说明：未捕获的服务器内部错误；`debug` 模式下会返回详细堆栈
    - HTTP 状态码：`500`

## 开发注意事项
- 在售与成交的必填项需按状态提供，否则将被拒收并记录失败原因
- `面积` 为正数；价格单位为 `万`
- 系统对小区名称做标准化与别名匹配，必要时会自动创建小区记录
- 推送数组长度上限：`10000`

## 相关端点
- 推送：`POST /api/push`
- 列表查询：`GET /api/properties`
- 导出：`GET /api/properties/export`